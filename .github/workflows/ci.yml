name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      admin: ${{ steps.filter.outputs.admin }}
      agent_node: ${{ steps.filter.outputs.agent_node }}
      agent_python: ${{ steps.filter.outputs.agent_python }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed components
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'src/**'
              - 'scripts/**'
              - 'tests/**'
              - 'openapi/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
            admin:
              - 'admin-panel/**'
            agent_node:
              - 'agent/**'
            agent_python:
              - 'agent-python/**'

  api-check:
    name: API Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api == 'true'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run API CI checks
        run: npm run ci:check

  admin-check:
    name: Admin Panel Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.admin == 'true'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: admin-panel/package-lock.json

      - name: Install admin dependencies
        run: npm --prefix admin-panel ci

      - name: Build admin panel
        run: npm --prefix admin-panel run build

  agent-node-check:
    name: Agent Node Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.agent_node == 'true'
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install agent dependencies
        run: pnpm --dir agent install --frozen-lockfile

      - name: Run agent node CI script
        run: pnpm --dir agent run ci

  agent-python-check:
    name: Agent Python Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.agent_python == 'true'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install ./agent-python
          python -m pip install pytest pytest-asyncio ruff

      - name: Lint python agent
        run: ruff check agent-python/src

      - name: Test python agent
        run: pytest -q agent-python
