name: Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'admin-panel/**'
      - 'agent/**'
      - 'agent-python/**'
      - 'installation/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      full_redeploy:
        description: 'Run full deploy fallback (update_all.sh)'
        required: false
        default: false
        type: boolean

concurrency:
  group: prod-deploy
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      api_changed: ${{ steps.filter.outputs.api }}
      admin_changed: ${{ steps.filter.outputs.admin }}
      agent_node_changed: ${{ steps.filter.outputs.agent_node }}
      agent_py_changed: ${{ steps.filter.outputs.agent_python }}
      infra_changed: ${{ steps.filter.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed components
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'src/**'
              - 'scripts/**'
              - 'openapi/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
            admin:
              - 'admin-panel/**'
            agent_node:
              - 'agent/**'
            agent_python:
              - 'agent-python/**'
            infra:
              - 'installation/**'
              - '.github/workflows/deploy.yml'

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api_changed == 'true' || needs.changes.outputs.infra_changed == 'true'
    timeout-minutes: 20
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Update API on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" 'bash -s' << 'REMOTE'
          set -euo pipefail
          cd /opt/coziyoo
          bash installation/scripts/update_api_service.sh
          API_PORT="${API_PORT:-3000}"
          curl -fsS --max-time 8 "http://127.0.0.1:${API_PORT}/v1/health" >/dev/null
          REMOTE

  deploy-admin:
    name: Deploy Admin Panel
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.admin_changed == 'true' || needs.changes.outputs.infra_changed == 'true'
    timeout-minutes: 20
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Update admin panel on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" 'bash -s' << 'REMOTE'
          set -euo pipefail
          cd /opt/coziyoo
          bash installation/scripts/update_admin_panel.sh
          ADMIN_PORT="${ADMIN_PORT:-8000}"
          curl -fsS --max-time 8 "http://127.0.0.1:${ADMIN_PORT}" >/dev/null
          REMOTE

  deploy-agent-node:
    name: Deploy Agent Node
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.agent_node_changed == 'true' || needs.changes.outputs.infra_changed == 'true'
    timeout-minutes: 20
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Update node agent on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" 'bash -s' << 'REMOTE'
          set -euo pipefail
          cd /opt/coziyoo
          bash installation/scripts/update_agent_service.sh
          REMOTE

  deploy-agent-python:
    name: Deploy Agent Python
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.agent_py_changed == 'true' || needs.changes.outputs.infra_changed == 'true'
    timeout-minutes: 20
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Update python agent on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" 'bash -s' << 'REMOTE'
          set -euo pipefail
          cd /opt/coziyoo
          bash installation/scripts/update_agent_python_service.sh
          AGENT_HTTP_HOST="${AGENT_HTTP_HOST:-127.0.0.1}"
          AGENT_HTTP_PORT="${AGENT_HTTP_PORT:-8787}"
          AGENT_HEALTH_PATH="${AGENT_HEALTH_PATH:-/health}"
          curl -fsS --max-time 8 "http://${AGENT_HTTP_HOST}:${AGENT_HTTP_PORT}${AGENT_HEALTH_PATH}" >/dev/null
          REMOTE

  deploy-all-fallback:
    name: Deploy All Fallback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.full_redeploy == true
    timeout-minutes: 30
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Run full deploy on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" 'bash -s' << 'REMOTE'
          set -euo pipefail
          cd /opt/coziyoo
          bash installation/scripts/update_all.sh
          REMOTE
