openapi: 3.1.0
info:
  title: Coziyoo API v1
  version: 1.0.0
  description: Versioned API contract for Coziyoo marketplace backend.
servers:
  - url: http://localhost:3000
    description: Local
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
      required: [error]
    PaginationOffset:
      type: object
      properties:
        mode:
          type: string
          enum: [offset]
        page:
          type: integer
        pageSize:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer
    Tokens:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        tokenType:
          type: string
      required: [accessToken, refreshToken, tokenType]
paths:
  /v1/health:
    get:
      tags: [health]
      security: []
      responses:
        '200':
          description: Service health
  /v1/auth/register:
    post:
      tags: [auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, displayName, userType]
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                displayName: { type: string }
                userType: { type: string, enum: [buyer, seller, both] }
      responses:
        '201': { description: Registered }
        '400': { description: Validation error }
        '409': { description: Duplicate email/display name }
  /v1/auth/login:
    post:
      tags: [auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        '200': { description: Logged in }
        '401': { description: Invalid credentials }
  /v1/auth/refresh:
    post:
      tags: [auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200': { description: Refreshed }
  /v1/auth/logout:
    post:
      tags: [auth]
      responses:
        '200': { description: Logged out }
  /v1/auth/me:
    get:
      tags: [auth]
      responses:
        '200': { description: Current user }
  /v1/auth/display-name/check:
    get:
      tags: [auth]
      security: []
      parameters:
        - in: query
          name: value
          required: true
          schema: { type: string }
      responses:
        '200': { description: Display name availability }
  /v1/admin/auth/login:
    post:
      tags: [admin-auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        '200': { description: Admin logged in }
  /v1/admin/auth/refresh:
    post:
      tags: [admin-auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200': { description: Refreshed }
  /v1/admin/auth/logout:
    post:
      tags: [admin-auth]
      responses:
        '200': { description: Logged out }
  /v1/admin/auth/me:
    get:
      tags: [admin-auth]
      responses:
        '200': { description: Current admin }
  /v1/docs:
    get:
      tags: [docs]
      security: []
      responses:
        '200': { description: Swagger UI page }
        '404': { description: Docs disabled }
  /v1/docs/openapi.yaml:
    get:
      tags: [docs]
      security: []
      responses:
        '200': { description: Raw OpenAPI YAML }
        '404': { description: Docs disabled }
  /v1/orders:
    post:
      tags: [orders]
      parameters:
        - in: header
          name: Idempotency-Key
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sellerId, deliveryType, items]
              properties:
                sellerId: { type: string, format: uuid }
                deliveryType: { type: string, enum: [pickup, delivery] }
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [foodId, quantity]
                    properties:
                      foodId: { type: string, format: uuid }
                      quantity: { type: integer, minimum: 1 }
      responses:
        '201': { description: Order created }
    get:
      tags: [orders]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        '200': { description: Orders list }
  /v1/orders/{id}/approve:
    post:
      tags: [orders]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Approved }
  /v1/orders/{id}/status:
    post:
      tags: [orders]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [toStatus]
              properties:
                toStatus:
                  type: string
                  enum: [seller_approved, rejected, awaiting_payment, preparing, ready, in_delivery, delivered, completed, cancelled]
                reason: { type: string }
      responses:
        '200': { description: Transition success }
  /v1/orders/{id}/allergen-disclosure/pre-order:
    post:
      tags: [allergen]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '201': { description: Disclosure saved }
  /v1/orders/{id}/allergen-disclosure/handover:
    post:
      tags: [allergen]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '201': { description: Disclosure saved }
  /v1/orders/{id}/delivery-proof/pin/send:
    post:
      tags: [delivery-proof]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '201': { description: PIN sent }
  /v1/orders/{id}/delivery-proof/pin/verify:
    post:
      tags: [delivery-proof]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: PIN verified }
  /v1/payments/start:
    post:
      tags: [payments]
      parameters:
        - in: header
          name: Idempotency-Key
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [orderId]
              properties:
                orderId: { type: string, format: uuid }
      responses:
        '201': { description: Payment session created }
  /v1/payments/return:
    get:
      tags: [payments]
      security: []
      parameters:
        - in: query
          name: sessionId
          required: true
          schema: { type: string }
        - in: query
          name: result
          required: false
          schema: { type: string, enum: [success, failed] }
      responses:
        '200': { description: Return handled }
  /v1/payments/webhook:
    post:
      tags: [payments]
      security: []
      parameters:
        - in: header
          name: x-provider-signature
          required: true
          schema: { type: string }
      responses:
        '200': { description: Webhook processed }
        '401': { description: Signature invalid }
  /v1/payments/{orderId}/status:
    get:
      tags: [payments]
      parameters:
        - in: path
          name: orderId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Payment status }
  /v1/seller/compliance/profile:
    get:
      tags: [compliance]
      responses:
        '200': { description: Seller compliance profile }
    put:
      tags: [compliance]
      responses:
        '200': { description: Seller compliance profile updated }
  /v1/seller/compliance/submit:
    post:
      tags: [compliance]
      responses:
        '200': { description: Seller compliance submitted }
  /v1/admin/compliance/queue:
    get:
      tags: [compliance]
      responses:
        '200': { description: Compliance queue }
  /v1/admin/compliance/{sellerId}/approve:
    post:
      tags: [compliance]
      parameters:
        - in: path
          name: sellerId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Compliance approved }
  /v1/admin/dashboard/overview:
    get:
      tags: [admin-dashboard]
      responses:
        '200': { description: Operational overview KPIs }
  /v1/admin/audit/events:
    get:
      tags: [admin-audit]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: source
          schema: { type: string, enum: [admin_audit, auth_audit, admin_auth_audit, abuse_risk, order_event, compliance_event, lot_event] }
        - in: query
          name: eventType
          schema: { type: string }
        - in: query
          name: actorId
          schema: { type: string }
        - in: query
          name: entityType
          schema: { type: string }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
        - in: query
          name: sortBy
          schema: { type: string, enum: [createdAt, source, eventType] }
        - in: query
          name: sortDir
          schema: { type: string, enum: [asc, desc] }
      responses:
        '200': { description: Unified audit events with filtering and pagination }
  /v1/admin/audit/events/export:
    get:
      tags: [admin-audit]
      parameters:
        - in: query
          name: source
          schema: { type: string, enum: [admin_audit, auth_audit, admin_auth_audit, abuse_risk, order_event, compliance_event, lot_event] }
        - in: query
          name: eventType
          schema: { type: string }
        - in: query
          name: actorId
          schema: { type: string }
        - in: query
          name: entityType
          schema: { type: string }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
      responses:
        '200': { description: CSV export for filtered audit events }
  /v1/admin/users:
    get:
      tags: [admin-users]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sortBy
          schema: { type: string, enum: [createdAt, updatedAt, email, displayName, userType, status] }
        - in: query
          name: sortDir
          schema: { type: string, enum: [asc, desc] }
        - in: query
          name: status
          schema: { type: string, enum: [active, disabled] }
        - in: query
          name: userType
          schema: { type: string, enum: [buyer, seller, both] }
        - in: query
          name: audience
          schema: { type: string, enum: [buyer, seller] }
        - in: query
          name: search
          schema: { type: string }
      responses:
        '200': { description: App users list }
    post:
      tags: [admin-users]
      responses:
        '201': { description: App user created (super_admin only) }
  /v1/admin/users/{id}:
    get:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: App user detail }
    put:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: App user updated (super_admin only) }
  /v1/admin/users/{id}/status:
    patch:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: App user status updated (super_admin only) }
  /v1/admin/users/{id}/role:
    patch:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: App user role updated (super_admin only) }
  /v1/admin/admin-users:
    get:
      tags: [admin-users]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sortBy
          schema: { type: string, enum: [createdAt, updatedAt, email, role, status] }
        - in: query
          name: sortDir
          schema: { type: string, enum: [asc, desc] }
        - in: query
          name: status
          schema: { type: string, enum: [active, disabled] }
        - in: query
          name: role
          schema: { type: string, enum: [admin, super_admin] }
        - in: query
          name: search
          schema: { type: string }
      responses:
        '200': { description: Admin users list }
    post:
      tags: [admin-users]
      responses:
        '201': { description: Admin user created (super_admin only) }
  /v1/admin/admin-users/{id}:
    get:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Admin user detail }
    put:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Admin user updated (super_admin only) }
  /v1/admin/admin-users/{id}/status:
    patch:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Admin user status updated (super_admin only) }
  /v1/admin/admin-users/{id}/role:
    patch:
      tags: [admin-users]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Admin user role updated (super_admin only) }
  /v1/admin/commission-settings:
    get:
      tags: [finance]
      responses:
        '200': { description: Commission settings }
    post:
      tags: [finance]
      responses:
        '201': { description: Commission setting created }
  /v1/sellers/{sellerId}/finance/summary:
    get:
      tags: [finance]
      parameters:
        - in: path
          name: sellerId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Seller finance summary }
  /v1/sellers/{sellerId}/finance/orders:
    get:
      tags: [finance]
      parameters:
        - in: path
          name: sellerId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Seller finance order ledger }
  /v1/orders/{id}/refund-request:
    post:
      tags: [finance]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
        - in: header
          name: Idempotency-Key
          required: true
          schema: { type: string }
      responses:
        '201': { description: Refund request opened as dispute }
  /v1/orders/{id}/disputes:
    get:
      tags: [finance]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Order disputes }
  /v1/admin/disputes:
    get:
      tags: [finance]
      responses:
        '200': { description: Admin disputes list }
  /v1/admin/disputes/{id}/resolve:
    post:
      tags: [finance]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Dispute resolved }
  /v1/sellers/{sellerId}/finance/reports:
    post:
      tags: [finance]
      parameters:
        - in: path
          name: sellerId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '201': { description: Seller report generated }
    get:
      tags: [finance]
      parameters:
        - in: path
          name: sellerId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Seller reports list }
  /v1/admin/finance/reports:
    post:
      tags: [finance]
      responses:
        '201': { description: Admin report generated }
    get:
      tags: [finance]
      responses:
        '200': { description: Admin reports list }
  /v1/seller/lots:
    post:
      tags: [lots]
      responses:
        '201': { description: Lot created }
    get:
      tags: [lots]
      responses:
        '200': { description: Seller lots }
  /v1/seller/lots/{lotId}/adjust:
    post:
      tags: [lots]
      parameters:
        - in: path
          name: lotId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Lot adjusted }
  /v1/seller/lots/{lotId}/recall:
    post:
      tags: [lots]
      parameters:
        - in: path
          name: lotId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Lot recalled }
  /v1/admin/lots:
    get:
      tags: [lots]
      responses:
        '200': { description: Admin lots list }
  /v1/admin/lots/{lotId}/orders:
    get:
      tags: [lots]
      parameters:
        - in: path
          name: lotId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Orders affected by lot }
  /v1/admin/metadata/entities:
    get:
      tags: [admin-metadata]
      responses:
        '200': { description: Admin entity list }
  /v1/admin/metadata/tables/{tableKey}/fields:
    get:
      tags: [admin-metadata]
      parameters:
        - in: path
          name: tableKey
          required: true
          schema: { type: string }
      responses:
        '200': { description: Dynamic field metadata for admin grids }
  /v1/admin/metadata/tables/{tableKey}/records:
    get:
      tags: [admin-metadata]
      parameters:
        - in: path
          name: tableKey
          required: true
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sortBy
          schema: { type: string }
        - in: query
          name: sortDir
          schema: { type: string, enum: [asc, desc] }
        - in: query
          name: search
          schema: { type: string }
      responses:
        '200': { description: Dynamic table record listing for admin data explorer }
  /v1/admin/table-preferences/{tableKey}:
    get:
      tags: [admin-metadata]
      parameters:
        - in: path
          name: tableKey
          required: true
          schema: { type: string }
      responses:
        '200': { description: Admin table preferences }
    put:
      tags: [admin-metadata]
      parameters:
        - in: path
          name: tableKey
          required: true
          schema: { type: string }
      responses:
        '200': { description: Admin table preferences updated }
